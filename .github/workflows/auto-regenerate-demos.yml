# Automated Demo Regeneration Workflow
# Automatically regenerates demo files when tools in src/tools/ change
# Ensures documentation stays in sync with codebase

name: Auto-Regenerate Demos

on:
  pull_request:
    paths:
      # Trigger on any TypeScript file changes in src/tools/
      - 'src/tools/**/*.ts'
      # Also trigger if the demo script itself changes
      - 'demos/demo-tools.js'

env:
  NODE_VERSION: '22'

jobs:
  regenerate-demos:
    name: 🔄 Regenerate Demo Files
    runs-on: ubuntu-latest
    # Only run on PRs, not on direct pushes to main
    if: github.event_name == 'pull_request'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v5
        with:
          # Checkout the PR branch, not the merge commit
          ref: ${{ github.head_ref }}
          # Need full history for proper git operations
          fetch-depth: 0
          # Use the GitHub token for authentication
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Regenerate demo files
        run: npm run test:demo

      - name: Check for demo changes
        id: check_changes
        run: |
          if git diff --quiet demos/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No demo file changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Demo files have been updated"
          fi

      - name: Commit and push demo changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add demos/*.md
          git commit -m "chore: auto-regenerate demos after tool changes

          Generated by GitHub Actions workflow
          Triggered by changes in src/tools/"
          git push

      - name: Add PR comment
        if: steps.check_changes.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '🔄 **Demo files automatically regenerated**\n\nThe demo files in `demos/` have been updated to reflect changes in `src/tools/`. Please review the changes to ensure they are correct.'
            })

      - name: Generate workflow summary
        if: always()
        run: |
          echo "## 🔄 Demo Regeneration Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "### ✅ Demos Updated" >> $GITHUB_STEP_SUMMARY
            echo "Demo files were regenerated and committed to the PR." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Changed files:**" >> $GITHUB_STEP_SUMMARY
            git diff --name-only HEAD~1 demos/ | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "- (unable to list changed files)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ℹ️ No Changes" >> $GITHUB_STEP_SUMMARY
            echo "Demo files are already up to date - no regeneration needed." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** Changes detected in \`src/tools/\`" >> $GITHUB_STEP_SUMMARY
          echo "**Script:** \`npm run test:demo\`" >> $GITHUB_STEP_SUMMARY
