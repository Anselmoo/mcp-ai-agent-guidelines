# Automated Demo Regeneration Workflow
# Automatically regenerates demo files when tools in src/tools/ change
# Ensures documentation stays in sync with codebase

name: Auto-Regenerate Demos

on:
  schedule:
    - cron: "0 2 * * 1" # Weekly on Mondays at 02:00 UTC
  workflow_dispatch:

env:
  NODE_VERSION: "22"

jobs:
  # ============================================================================
  # Lint & Code Quality Check - Required by Branch Protection
  # ============================================================================
  lint-code-quality:
    name: Lint & Code Quality (Lefthook)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install gitleaks
        run: |
          curl -sSL https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks-linux-amd64 -o gitleaks
          chmod +x gitleaks
          sudo mv gitleaks /usr/local/bin/gitleaks

      - name: Install lefthook
        run: npm run hooks:install

      - name: Run lefthook pre-commit checks
        id: lefthook_check
        run: npx lefthook run pre-commit --verbose

      - name: Generate quality check summary
        if: success()
        run: |
          echo "## ðŸª Lefthook Quality Check (Auto-Regenerate Workflow)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Quality Gates Passed" >> $GITHUB_STEP_SUMMARY
          echo "Pre-commit quality checks completed successfully before demo regeneration." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This job ensures branch protection requirements are met." >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Demo Regeneration Job
  # ============================================================================
  regenerate-demos-weekly:
    name: ðŸ”„ Regenerate Demo Files (Weekly)
    runs-on: ubuntu-latest
    needs: lint-code-quality
    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Regenerate demo files
        run: npm run test:demo

      - name: Validate demo coverage
        id: validate_coverage
        run: |
          if npm run validate:demo-coverage; then
            echo "coverage_ok=true" >> $GITHUB_OUTPUT
            echo "âœ… All tools have demos"
          else
            echo "coverage_ok=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Some tools are missing demos"
          fi
        continue-on-error: true

      - name: Check for demo changes
        id: check_changes
        run: |
          if git diff --quiet demos/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No demo file changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Demo files have been updated"
          fi

      - name: Commit and push demo changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add demos/*.md
          git commit -F- <<-EOF
          chore: auto-regenerate demos after tool changes

          Generated by GitHub Actions workflow
          Triggered by scheduled weekly run

          [skip ci]
          EOF
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate workflow summary
        if: always()
        run: |
          echo "## ðŸ”„ Demo Regeneration Report (Weekly Schedule)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "### âœ… Demos Updated" >> $GITHUB_STEP_SUMMARY
            echo "Demo files were regenerated and committed to main." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Changed files:**" >> $GITHUB_STEP_SUMMARY
            git diff --name-only HEAD~1 demos/ | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "- (unable to list changed files)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ No Changes" >> $GITHUB_STEP_SUMMARY
            echo "Demo files are already up to date - no regeneration needed." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add coverage validation results
          if [ "${{ steps.validate_coverage.outputs.coverage_ok }}" == "false" ]; then
            echo "### âš ï¸ Demo Coverage Warning" >> $GITHUB_STEP_SUMMARY
            echo "Some tools are missing demos. Run \`npm run validate:demo-coverage\` locally to identify which tools need demos." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**Trigger:** Scheduled weekly run" >> $GITHUB_STEP_SUMMARY
          echo "**Script:** \`npm run test:demo\`" >> $GITHUB_STEP_SUMMARY
          echo "**Validation:** \`npm run validate:demo-coverage\`" >> $GITHUB_STEP_SUMMARY
