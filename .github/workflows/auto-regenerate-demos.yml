# Automated Demo Regeneration Workflow
# Automatically regenerates demo files when tools in src/tools/ change
# Ensures documentation stays in sync with codebase

name: Auto-Regenerate Demos

on:
  schedule:
    - cron: "0 2 * * 1" # Weekly on Mondays at 02:00 UTC
  workflow_dispatch:

env:
  NODE_VERSION: "22"

jobs:
  regenerate-demos-weekly:
    name: ðŸ”„ Regenerate Demo Files (Weekly)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Regenerate demo files
        run: npm run test:demo

      - name: Validate demo coverage
        id: validate_coverage
        run: |
          if npm run validate:demo-coverage; then
            echo "coverage_ok=true" >> $GITHUB_OUTPUT
            echo "âœ… All tools have demos"
          else
            echo "coverage_ok=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Some tools are missing demos"
          fi
        continue-on-error: true

      - name: Check for demo changes
        id: check_changes
        run: |
          if git diff --quiet demos/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No demo file changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Demo files have been updated"
          fi

      - name: Commit and push demo changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          # Create a unique branch name with timestamp
          BRANCH_NAME="auto-regenerate-demos-$(date +%Y%m%d-%H%M%S)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create and checkout new branch from main
          git checkout -b "$BRANCH_NAME"
          
          # Stage and commit changes
          git add demos/*.md
          git commit -m "chore: auto-regenerate demos after tool changes" -m "Generated by GitHub Actions workflow" -m "Triggered by scheduled weekly run"
          
          # Push the new branch
          git push origin "$BRANCH_NAME"
        id: commit_changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          BRANCH_NAME="${{ steps.commit_changes.outputs.branch_name }}"
          
          gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "chore: auto-regenerate demos ($(date +%Y-%m-%d))" \
            --body "## ðŸ¤– Automated Demo Regeneration

          This PR was automatically created by the weekly demo regeneration workflow.

          ### ðŸ“‹ Changes
          - Regenerated demo files to sync with latest tool changes
          - Triggered by: Scheduled weekly run on $(date +%Y-%m-%d)

          ### âœ… Validation
          - Demo coverage validation: ${{ steps.validate_coverage.outputs.coverage_ok == 'true' && 'âœ… All tools have demos' || 'âš ï¸ Some tools missing demos' }}

          ### ðŸ” Review Instructions
          1. Review the updated demo files in the \`demos/\` directory
          2. Verify that the demos accurately reflect the current tool functionality
          3. Ensure all required status checks pass
          4. Merge when ready

          ---
          *This PR will go through all required status checks including 'Lint & Code Quality (Lefthook)' before it can be merged.*"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate workflow summary
        if: always()
        run: |
          echo "## ðŸ”„ Demo Regeneration Report (Weekly Schedule)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "### âœ… Pull Request Created" >> $GITHUB_STEP_SUMMARY
            echo "Demo files were regenerated and a pull request was created." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Branch:** \`${{ steps.commit_changes.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "**Target:** \`main\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The PR will go through all required status checks including 'Lint & Code Quality (Lefthook)' before it can be merged." >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ No Changes" >> $GITHUB_STEP_SUMMARY
            echo "Demo files are already up to date - no regeneration needed." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add coverage validation results
          if [ "${{ steps.validate_coverage.outputs.coverage_ok }}" == "false" ]; then
            echo "### âš ï¸ Demo Coverage Warning" >> $GITHUB_STEP_SUMMARY
            echo "Some tools are missing demos. Run \`npm run validate:demo-coverage\` locally to identify which tools need demos." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**Trigger:** Scheduled weekly run" >> $GITHUB_STEP_SUMMARY
          echo "**Script:** \`npm run test:demo\`" >> $GITHUB_STEP_SUMMARY
          echo "**Validation:** \`npm run validate:demo-coverage\`" >> $GITHUB_STEP_SUMMARY
