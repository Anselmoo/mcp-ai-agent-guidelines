# ðŸ”§ P4-004: Implement SpecKitStrategy - spec.md Generation [serial]

> **Parent**: #698
> **Labels**: `phase-4a`, `priority-high`, `serial`, `copilot-suitable`, `mcp-serena`
> **Milestone**: M5: Spec-Kit Core
> **Estimate**: 6 hours
> **Depends On**: P4-002, P4-003
> **Blocks**: P4-005, P4-006

## Context

The spec.md is the primary Spec-Kit document containing requirements, objectives, and acceptance criteria.

## Task Description

Implement spec.md generation in SpecKitStrategy:

**Create `src/strategies/speckit-strategy.ts`:**
```typescript
import type { OutputStrategy, OutputArtifacts, OutputApproach, OutputDocument } from '../output-strategy.js';
import type { ParsedSpec, Plan, DerivedTask, Progress, Constitution } from './types.js';

export interface SpecKitRenderOptions {
  constitution?: Constitution;
  includeConstitutionalConstraints?: boolean;
  validateBeforeRender?: boolean;
}

export class SpecKitStrategy implements OutputStrategy<any> {
  readonly approach = OutputApproach.SPECKIT;

  render(result: any, options?: SpecKitRenderOptions): OutputArtifacts {
    const spec = this.extractSpec(result, options);

    return {
      primary: this.renderReadme(result),
      secondary: [
        this.renderSpec(spec, options),
        this.renderPlan(result),
        this.renderTasks(result),
        this.renderProgress(result),
      ],
    };
  }

  supports(domainType: string): boolean {
    return ['SessionState'].includes(domainType);
  }

  private renderSpec(spec: ParsedSpec, options?: SpecKitRenderOptions): OutputDocument {
    const content = `# Specification: ${spec.title}

## Overview

${spec.overview}

## Objectives

${spec.objectives.map(o => `### ${o.id}: ${o.description}
**Priority**: ${o.priority}
`).join('\n')}

## Functional Requirements

${spec.functionalRequirements.map(r => `### ${r.id}
${r.description}
**Priority**: ${r.priority}
`).join('\n')}

## Non-Functional Requirements

${spec.nonFunctionalRequirements.map(r => `### ${r.id}
${r.description}
**Priority**: ${r.priority}
`).join('\n')}

${options?.includeConstitutionalConstraints && options.constitution ? this.renderConstraints(spec.constraints, options.constitution) : ''}

## Acceptance Criteria

${spec.acceptanceCriteria.map(ac => `- [ ] **${ac.id}**: ${ac.description} _(${ac.verificationMethod})_`).join('\n')}

## Out of Scope

${spec.outOfScope.map(item => `- ${item}`).join('\n')}

---
*Generated by SpecKitStrategy*
`;

    return {
      name: 'spec.md',
      content,
      format: 'markdown',
    };
  }

  private renderConstraints(constraints: ConstraintReference[], constitution: Constitution): string {
    if (constraints.length === 0) return '';

    return `## Constitutional Constraints

${constraints.map(c => {
      const item = this.findConstitutionItem(c.constitutionId, constitution);
      return `### ${c.constitutionId}: ${item?.title ?? 'Unknown'}
${item?.description ?? ''}
${c.notes ? `\n**Notes**: ${c.notes}` : ''}
`;
    }).join('\n')}`;
  }

  private findConstitutionItem(id: string, constitution: Constitution) {
    // Search through all constitution sections
  }

  private extractSpec(result: any, options?: SpecKitRenderOptions): ParsedSpec {
    // Extract spec from domain result
  }
}
```

## Acceptance Criteria

- [ ] File: `src/strategies/speckit-strategy.ts`
- [ ] `renderSpec()` generates complete spec.md
- [ ] Overview section
- [ ] Objectives section with priorities
- [ ] Functional requirements section
- [ ] Non-functional requirements section
- [ ] Constitutional constraints section (if constitution provided)
- [ ] Acceptance criteria with checkboxes
- [ ] Out of scope section
- [ ] Unit tests

## Files to Create

- `src/strategies/speckit-strategy.ts`
- `tests/vitest/strategies/speckit-strategy.spec.ts`

## Verification

```bash
npm run build && npm run test:vitest -- speckit-strategy
```

## References

- [SPEC-005: Spec-Kit Integration](https://github.com/Anselmoo/mcp-ai-agent-guidelines/blob/development/plan-v0.13.x/specs/SPEC-005-speckit-integration.md)
- [GitHub Spec-Kit spec.md format](https://github.com/github/spec-kit)
- [TASKS Phase 4](https://github.com/Anselmoo/mcp-ai-agent-guidelines/blob/development/plan-v0.13.x/tasks/TASKS-phase-4-speckit-integration.md) P4-004
